trigger:
  branches:
    include:
      - main

pool:
  name: 'linux-hosted-agent-pool'

variables:
  - group: Terraform-AWS-Creds   # contains AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, db_username, db_password
  - name: EC2_KEYPAIR_NAME
    value: "ubuntu-key"
  - name: terraformVersion
    value: "1.6.0"
  - name: tfWorkingDir
    value: "terraform"

stages:
  - stage: Terraform_Infra
    displayName: "Provision AWS Infrastructure"
    jobs:
      - job: Terraform
        displayName: "Terraform Plan and Apply"
        steps:

          # Install Terraform
          - task: TerraformInstaller@0
            inputs:
              terraformVersion: $(terraformVersion)

          # Terraform Init
          - script: terraform init 
            workingDirectory: $(System.DefaultWorkingDirectory)/$(tfWorkingDir)
            env:
              AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
              AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
              AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)

          # Terraform Plan
          - script: terraform plan -var-file=terraform.tfvars -out=tfplan
            workingDirectory: $(System.DefaultWorkingDirectory)/$(tfWorkingDir)
            env:
              AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
              AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
              AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)

          # Terraform Apply
          - script: terraform apply -auto-approve tfplan
            workingDirectory: $(System.DefaultWorkingDirectory)/$(tfWorkingDir)
            env:
              AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
              AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
              AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)

          # Capture outputs
          - script: |
              echo "##vso[task.setvariable variable=frontend_public_ip]$(terraform output -raw frontend_public_ip)"
              echo "##vso[task.setvariable variable=backend_public_ip]$(terraform output -raw backend_public_ip)"
              echo "##vso[task.setvariable variable=mysql_endpoint]$(terraform output -raw mysql_endpoint)"
            workingDirectory: $(System.DefaultWorkingDirectory)/$(tfWorkingDir)
            displayName: "Publish Terraform Outputs"
